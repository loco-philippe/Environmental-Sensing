<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="icon" href="https://loco-philippe.github.io/ES/logo_loco.png"> <!-- pas très lisible -->
        <title>Outil de recherche Essearch basé sur MongoDB</title>
        <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
        <script type="text/javascript">
            var uri = '', database_name = '', collection_name = '', req_count = -1, column_names, 
                added_fields = [0];

            function set_uri (value) {uri = value; Validation_Mongo();}
            function set_database_name (value) {database_name = value; Validation_Mongo();}
            function set_collection_name (value) {collection_name = value; Validation_Mongo();}

            function setMongoValidity (validity) {
                if (validity === 'Valide') {
                    document.getElementById("mongo_validity").innerHTML = "Valide";
                    document.getElementById("mongo_validity").style.color = "green";
                    document.getElementById("coll_stats").innerHTML = "...";
                } else if (validity === 'Invalide') {
                    document.getElementById("mongo_validity").innerHTML = "Invalide";
                    document.getElementById("mongo_validity").style.color = "red";
                    document.getElementById("coll_stats").innerHTML = "";
                } else {
                    document.getElementById("mongo_validity").innerHTML = "Erreur";
                    document.getElementById("mongo_validity").style.color = "red";
                    document.getElementById("coll_stats").innerHTML = "";
                }
            }

            function loadCondition (i) {
                // à faire (affichage de la partie conditions une fois que la base est valide)
                if (document.getElementById("name-select_" + i).value === "exact-path") {document.getElementById("exact-path-input-div_" + i).hidden = false;}
                else {document.getElementById("exact-path-input-div_" + i).hidden = true;}
            }

            function exactPathVisibility (i) {
                document.getElementById("exact-path-input-div_" + i).hidden = 
                        !(document.getElementById("name-select_" + i).value === "exact-path");
            }

            function insertNamesInSelectors () {
                var name_selectors = document.getElementsByClassName("name-select");
                for (var i = 0; i < name_selectors.length; i++) {
                    name_selectors[i].options.length = 0;
                    column_names.forEach(option => name_selectors[i].add(new Option(option, option)));
                    name_selectors[i].add(new Option("Entrer un chemin exact.", "exact-path"))
                    name_selectors[i].disabled = false;
                    exactPathVisibility (i);
                }
                var exact_path_fields = document.querySelectorAll("option[value='exact-path']");
                for (var i = 0; i < exact_path_fields.length; i++) {exact_path_fields[i].style.fontStyle = 'italic';}
            }

            function addField (i) {
                const parent = document.getElementById("cond_" + i)
                parent.insertAdjacentHTML("beforeend", "<div class=\"additional-field\" id=\"additional-field_" + i + "_" + 
                    added_fields[i] + "\">Paramètre supplémentaire : <input type='text' class=\"param-name-field\" \
                    > Valeur : <input type='text' class=\"param-value-field\"> <button id=\"remove_field_" +
                    i + "_" + added_fields[i] + "\" onclick=\"removeField(" + i + "," + added_fields[i] +
                    ")\">Enlever ce champ</button></div>");
                added_fields[i] += 1;
            }

            function removeField (i, j) {
                document.getElementById("cond_" + i).removeChild(document.getElementById("additional-field_" + i + "_" + j));
            }

            function addCondition () {
                var parent = document.getElementById("conds");
                var div = document.createElement("div");
                div.className = "cond";
                div.id = "cond_" + added_fields.length;
                div.innerHTML = "<p>Colonne : <select name=\"column_name\" \
                    class=\"name-select\" id=\"name-select_" + added_fields.length + "\" oninput=\"exactPathVisibility (" +
                    added_fields.length + ")\"></select> Opérateur : <input type=\"text\" \
                    class=\"operator-input\" id=\"operator-input_" + added_fields.length + 
                    "\"> Valeur de comparaison : <input type=\"text\" class=\"operand-input\" id=\"operand-input_" +
                    added_fields.length + "\"> <button id=\"add_field_" + added_fields.length + 
                    "\" onclick=\"addField (" + added_fields.length + ")\">Ajouter un champ à cette condition</button> \
                    <button id=\"remove_condition_" +  added_fields.length + "\" onclick=\"removeCondition (" +  
                    added_fields.length + ")\">Enlever cette condition</button></p><div class=\"exact-path-input-div\" \
                    id=\"exact-path-input-div_" + added_fields.length + "\" hidden>Chemin exact : <input type=\"text\" \
                    class=\"exact-path-input\" id=\"exact-path-input_" + added_fields.length + "\"></div>";
                parent.appendChild(div);
                var sel = document.getElementById("name-select_" + added_fields.length);
                column_names.forEach(option => sel.add(new Option(option, option)));
                sel.add(new Option("Entrer un chemin exact.", "exact-path"))
                document.querySelectorAll("option[value='exact-path']")[added_fields.length].style.fontStyle = 'italic';
                exactPathVisibility (added_fields.length);
                added_fields[added_fields.length] = 0;
            }

            function removeCondition (i) {
                document.getElementById("conds").removeChild(document.getElementById("cond_" + i));
                delete added_fields[i];
            }

            function Validation_Mongo () {
                // Effectue la requête POST envoyant uri, database_name et collection_name
                req_count += 1;
                var req_id = req_count;
                if (document.getElementById("mongo_validity").innerHTML === "Valide") {document.getElementById("coll_stats").innerHTML = "...";}
                var name_selectors = document.querySelectorAll("name-select");
                for (var i = 0; i < name_selectors.length; i++) {exact_path_fields[i].disabled = true;}
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.open("POST", "/", true);
                xmlHttp.setRequestHeader("Content-Type", "application/json");
                xmlHttp.send(JSON.stringify({request_type:'mongo-validation', uri:uri, database_name:database_name, collection_name:collection_name}));
                xmlHttp.onload = () => { if (xmlHttp.readyState === xmlHttp.DONE && xmlHttp.status === 200 && req_id === req_count) {
                    if (xmlHttp.responseText === "mongo_data is valid") {
                        setMongoValidity ("Valide");
                        var ask = new XMLHttpRequest();
                        ask.open("POST", "/", true);
                        ask.setRequestHeader("Content-Type", "application/json");
                        ask.send(JSON.stringify({request_type:'mongo-validation-namelist', uri:uri, database_name:database_name, 
                                    collection_name:collection_name}));
                        ask.onreadystatechange = () => {if (ask.readyState === ask.DONE && ask.status === 200 && req_id === req_count) {
                            var json_ask = JSON.parse(ask.responseText);
                            document.getElementById("coll_stats").innerHTML = "La collection contient " + json_ask.count + " éléments.";
                            if (json_ask.count === 0) {document.getElementById("coll_stats").innerHTML += 
                                    " Cela signifie que cette collection MongoDB n'existe pas ou qu'aucune donnée n'y a été insérée."}
                            column_names = json_ask.column_names;
                            insertNamesInSelectors ();
                        }} 
                    } else {
                        setMongoValidity ("Invalide");
                    }
                }}
                xmlHttp.onerror = () => { setMongoValidity ("Erreur"); }
            }

            function execute () {
                if (document.getElementById("mongo_validity").innerHTML === "Valide") {
                    document.getElementById("request-result").innerHTML = "..."
                    document.getElementById("request-result").style.color = "black";
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "/", true);
                    xhr.setRequestHeader("Content-Type", "application/json");
                    var condArray = [], param;
                    for (var i in added_fields) {
                        var div = document.getElementById("cond_" + i); // est-ce bien le plus optimisé ?
                        condArray.push({});
                        param = div.querySelector('#name-select_' + i).value;
                        if (param && param !== '' && param !== "Entrer un chemin exact.") {
                            condArray[i]['name'] = param;
                        } else if (param === "Entrer un chemin exact.") {
                            var path = div.querySelector('#exact-path-input_' + i).value;
                            if (path && path !== '') {condArray[i]['path'] = path;}
                        }
                        param = div.querySelector('#operator-input_' + i).value;
                        if (param && param !== '') {condArray[i]['operator'] = param;}
                        param = div.querySelector('#operand-input_' + i).value;
                        if (param && param !== '') {condArray[i]['operand'] = param;}
                        var add = div.getElementsByClassName('additional-field');
                        for (var j = 0; j < add.length; j++) {
                            var n = add[j].getElementsByClassName("param-name-field")[0].value,
                                v = add[j].getElementsByClassName("param-value-field")[0].value;
                            if (n && v && n !== '' && v !== '') {condArray[i][n] = v;}
                        }
                    }
                    xhr.send(JSON.stringify({request_type:'execute', uri:uri, database_name:database_name,
                            collection_name:collection_name, parameters:condArray}));
                    xhr.onerror = () => {
                        document.getElementById("request-result").innerHTML = "Erreur";
                        document.getElementById("request-result").style.color = "red";
                    }
                    xhr.onreadystatechange = () => { if (xhr.readyState === xhr.DONE && xhr.status === 200) {
                        document.getElementById("request-result").innerHTML = xhr.responseText; // temp
                        document.getElementById("request-result").style.color = "black";
                        /* à faire
                        Ce qui est reçu est ... ? à voir ; voir ce qui est fait côté client et côté serveur
                        */
                    }}
                } else {
                    document.getElementById("request-result").innerHTML = "La collection est invalide. Impossible d'exécuter la requête."
                    document.getElementById("request-result").style.color = "red";
                }
            }
        </script>
    </head>
    <body>
        <h1>Outil de requêtes</h1>
        <h2>Paramètres de la base de données</h2>
        <!-- Considérer l'utilisation de Cookies pour retrouver les valeurs précédentes -->
        <p id="db_selection">
            URI complète : <input type="text" id="URI_mongo-input" oninput="set_uri (this.value)">
            <!-- si possible, ajouter un point d'interrogation expliquant au survol ce qu'est une URI Mongo et comment la créer -->
            Nom de la base : <input type="text" id="base_name-input" oninput="set_database_name (this.value)">
            Nom de la collection : <input type="text" id="collection_name-input" oninput="set_collection_name (this.value)">
        </p>
        <div id="mongo_validity"></div>
        <div id="coll_stats"></div>
        <h2>Paramètres de la requête</h2>
        <!-- Ne s'affiche / n'est dégrisé qu'une fois l'étape précédente validée (la requête vide a lieu entre temps) -->
        <div id="conds">
            <div class="cond" id="cond_0">
        <p>
            Colonne : <select name="column_name" class="name-select" id="name-select_0" oninput="exactPathVisibility (0)"></select>
            Opérateur : <input type="text" class="operator-input" id="operator-input_0">
            <!-- à voir si une liste des opérateurs associés à la colonne choisie peut être déterminée avec les infos
                (liste n'empêchant pas la saisie manuelle) -->
            Valeur de comparaison : <input type="text" class="operand-input" id="operand-input_0">
            <button id="add_field_0" onclick="addField (0)">Ajouter un champ à cette condition</button>
            <button id="remove_condition_0" onclick="removeCondition (0)">Enlever cette condition</button>
        </p>
        <div class="exact-path-input-div" id="exact-path-input-div_0" hidden>Chemin exact : <input type="text" class="exact-path-input" id="exact-path-input_0"></div>
        </div>
        </div>
        <button id="add_condition" onclick="addCondition ()">Ajouter une condition</button>
        <button id="execute" onclick="execute ()">Exécuter la requête</button>
        <div id="request-result"></div>
        <h2>Affichage des données</h2>
        <p>
            Type d'affichage : 
            <select name="rendering_format" id="rendering-select">
                <option value="bar-chart">Histogramme</option>
                <option value="curve">Courbe</option>
                <option value="map">Carte</option>
            </select>
            <!--
                Peu pertinent d'écrire la suite maintenant sans savoir quels seront les paramètres demandés
                + Ils seront potentiellement différents pour chaque type de graphique.
                -> Si traitement côté client, nécessaire d'avoir la conversion de format observation côté client.
                -> Si traitement côté serveur, nécessaire d'effectuer une nouvelle requête pour changer le type de diagramme
                 (pas garanti que le format adapté soit réellement différent selon les cas)
            -->

        </p>
        <div class='container'>
            <figure id='graphic'>

            </figure>
        </div>
    </body>
</html>